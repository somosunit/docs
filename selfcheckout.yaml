swagger: "2.0"
info:
  title: Self Checkout API
  description: API para gestao do sistema de autoatendimento de credito consignado
  version: "1.0.0"
basePath: /selfcheckout
tags:
  - name: Assinatura
    description: Endpoints relacionados a assinatura e autorizacao
  - name: Vinculos
    description: Endpoints para consulta de vinculos empregatícios
  - name: Credito
    description: Endpoints para analise e concessao de credito
  - name: Contrato
    description: Endpoints para geracao de contratos

securityDefinitions:
  InternalToken:
    type: apiKey
    name: Authorization
    in: header
    description: Token interno de autenticacao. Requer decorator @internal_token_required

paths:
  /sendSignature:
    post:
      tags:
        - Assinatura
      summary: Envia assinatura eletronica para consulta de vinculos
      description: |
        Endpoint responsavel por enviar a assinatura eletronica do cliente
        para a API da QI Tech, autorizando a consulta de seus vinculos empregatícios.

        Regras de negocio:
        - Verifica se existe sessao com menos de 7 dias para o CPF (retorna dados existentes se houver)
        - Valida o telefone no formato brasileiro
        - Verifica se o telefone ja foi utilizado nos ultimos 15 dias por outro CPF
        - Cria uma nova sessao no Firestore apos sucesso
      security:
        - InternalToken: []
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: body
          description: Dados para envio da assinatura
          required: true
          schema:
            type: object
            required:
              - cpf
              - name
              - ip
              - phone
            properties:
              cpf:
                type: string
                description: CPF do cliente (apenas numeros)
                example: "17734888720"
              name:
                type: string
                description: Nome completo do cliente
                example: "Alice Perim Borges"
              phone:
                type: string
                description: Telefone com DDI+DDD+numero
                example: "5527999407798"
              ip:
                type: string
                description: Endereco IP publico do cliente
                example: "193.186.4.237"
              email:
                type: string
                description: Email do cliente (opcional)
                example: "alice@email.com"
      responses:
        "200":
          description: Assinatura enviada com sucesso ou sessao existente encontrada
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: true
              data:
                type: object
                description: Dados da resposta da API QI Tech
                properties:
                  employment_relationships_inquiry_key:
                    type: string
                    description: Chave unica da consulta de vinculos
                  employment_relationships_inquiry_status:
                    type: string
                    description: Status da consulta
        "400":
          description: Erro de validacao
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
                enum:
                  - Requisicao deve ser em formato JSON
                  - Campo 'cpf' e obrigatorio
                  - Campo 'name' e obrigatorio
                  - Campo 'ip' e obrigatorio
                  - Campo 'phone' e obrigatorio
                  - Telefone invalido
                  - Telefone ja utilizado por outro CPF
        "500":
          description: Erro ao enviar assinatura para API QI Tech
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
                example: "Erro ao enviar assinatura"
              details:
                type: object
                description: Detalhes do erro da API

  /getVinculos:
    get:
      tags:
        - Vinculos
      summary: Retorna os vinculos empregatícios de um CPF
      description: |
        Busca todos os vinculos empregatícios associados a um CPF.
        Os vinculos sao retornados em ordem decrescente de data de vinculo.

        Os dados sao obtidos a partir de sessoes anteriores armazenadas no Firestore.
      security:
        - InternalToken: []
      produces:
        - application/json
      parameters:
        - in: query
          name: cpf
          type: string
          required: true
          description: CPF do cliente (pode conter pontos e virgulas, serao removidos)
      responses:
        "200":
          description: Vinculos encontrados com sucesso
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: true
              data:
                type: array
                description: Lista de vinculos empregatícios
                items:
                  type: object
                  properties:
                    employer_name:
                      type: string
                      description: Nome do empregador
                    employer_document_number:
                      type: string
                      description: CNPJ do empregador
                    registration_number:
                      type: string
                      description: Matricula do funcionario
                    admission_date:
                      type: string
                      format: date
                      description: Data de admissao
        "400":
          description: CPF nao informado
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
                example: "CPF e um parametro obrigatorio"
        "404":
          description: Nenhum vinculo encontrado
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
                example: "Nenhum vinculo encontrado para o CPF informado"

  /findFundingPartners:
    get:
      tags:
        - Credito
      summary: Busca fundos de credito disponiveis para um CNPJ
      description: |
        Retorna os fundos de credito que possuem o CNPJ informado em sua lista
        de empresas conveniadas/associadas.

        Fundos disponiveis:
        - Piemonte (CNPJ: 61452743000197)
        - AB013 (CNPJ: 58078602000141)
        - AB005 (CNPJ: 53285246000113)
        - AB017 (CNPJ: 59903568000165) - inclui lista de parceiros

        Para o fundo AB017, tambem retorna os parceiros de credito associados.
      security:
        - InternalToken: []
      produces:
        - application/json
      parameters:
        - in: query
          name: cnpj
          type: string
          required: true
          description: CNPJ da empresa (minimo 8 digitos - raiz)
      responses:
        "200":
          description: Fundos encontrados
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: true
              data:
                type: array
                items:
                  type: object
                  properties:
                    name:
                      type: string
                      description: Nome do fundo
                      enum:
                        - Piemonte
                        - AB013
                        - AB005
                        - AB017
                    cnpj_funding:
                      type: string
                      description: CNPJ do fundo
                    partners:
                      type: array
                      description: Lista de parceiros (apenas para AB017)
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          priority:
                            type: integer
        "400":
          description: CNPJ invalido ou nao informado
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
                enum:
                  - CNPJ e um parametro obrigatorio
                  - CNPJ deve ter ao menos 8 digitos (raiz).

  /createCard:
    post:
      tags:
        - Credito
      summary: Cria um card de acompanhamento no sistema de autoatendimento
      description: |
        Cria um novo card no sistema de tracking do self-checkout para
        acompanhamento da proposta de credito do cliente.

        Regras de negocio:
        - Valida telefone no formato brasileiro
        - Valida CPF
        - Verifica se ja existe proposta ativa para o CPF (impede duplicidade)
        - Cria o card na fase inicial (phase_id: 1)
      security:
        - InternalToken: []
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: body
          required: true
          schema:
            type: object
            required:
              - fullName
              - phone
              - documentNumber
              - companyName
              - email
              - origin
              - requestValue
            properties:
              fullName:
                type: string
                description: Nome completo do cliente
                example: "Joao da Silva"
              phone:
                type: string
                description: Telefone do cliente
                example: "5527999999999"
              documentNumber:
                type: string
                description: CPF do cliente
                example: "12345678900"
              companyName:
                type: string
                description: Nome da empresa onde o cliente trabalha
                example: "Empresa LTDA"
              email:
                type: string
                description: Email do cliente
                example: "joao@email.com"
              origin:
                type: string
                description: Origem/canal da solicitacao
                example: "Landing Page"
              requestValue:
                type: number
                description: Valor solicitado pelo cliente
                example: 5000.00
      responses:
        "200":
          description: Card criado com sucesso
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: true
              data:
                type: integer
                description: ID do card criado no sistema de tracking
                example: 12345
        "400":
          description: Erro de validacao
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
                enum:
                  - Requisicao deve ser em formato JSON
                  - Campo 'fullName' e obrigatorio
                  - Campo 'phone' e obrigatorio
                  - Campo 'documentNumber' e obrigatorio
                  - Campo 'companyName' e obrigatorio
                  - Campo 'email' e obrigatorio
                  - Campo 'origin' e obrigatorio
                  - Campo 'requestValue' e obrigatorio
                  - Telefone invalido
                  - CPF invalido
                  - Ja existe uma proposta ativa para o CPF informado
        "500":
          description: Erro ao criar card no sistema de tracking
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
                example: "Erro ao criar o cartao de autoatendimento"
              details:
                type: object

  /calculateCreditScore:
    post:
      tags:
        - Credito
      summary: Calcula o score de credito do cliente
      description: |
        Calcula o score de credito baseado em dados de inadimplencia historica.

        Regras duras (reprovacao automatica):
        - Tempo de vinculo < 12 meses
        - Empresa com menos de 24 meses de constituicao
        - Raiz de CNPJ com inadimplencia historica da 1a parcela > 15%

        Pontuacao:
        - Tempo de vinculo: ate 30 pontos
          - 12-24 meses: 8 pts
          - 24-36 meses: 15 pts
          - 36-60 meses: 25 pts
          - >= 60 meses: 30 pts

        - CNPJ (historico >= 10 contratos): ate 25 pontos
          - Inadimplencia <= 5%: 25 pts
          - 5-8%: 15 pts
          - 8-12%: 5 pts
          - > 12%: 0 pts
          - Amostra insuficiente: 10 pts

        Decisao baseada no score:
        - >= 70: Aprova pleno (Prazo e TM liberados)
        - 60-69: Aprova (Monitorar)
        - < 60: Reprova
      security:
        - InternalToken: []
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: body
          required: true
          schema:
            type: object
            required:
              - tempo_vinculo_meses
              - tempo_empresa_meses
              - cnpj_data
              - cnae_data
              - cbo_data
            properties:
              tempo_vinculo_meses:
                type: integer
                description: Tempo de vinculo do trabalhador em meses
                example: 36
              tempo_empresa_meses:
                type: integer
                description: Tempo de empresa aberta em meses
                example: 48
              cnpj_data:
                type: string
                description: Raiz do CNPJ (8 digitos)
                example: "12345678"
              cnae_data:
                type: string
                description: Codigo CNAE (8 digitos)
                example: "47113001"
              cbo_data:
                type: string
                description: Codigo CBO (4 primeiros digitos)
                example: "5211"
      responses:
        "200":
          description: Score calculado com sucesso
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: true
              data:
                type: object
                properties:
                  score:
                    type: integer
                    description: Score calculado (0-55)
                    example: 70
                  decisao:
                    type: string
                    description: Decisao de credito
                    enum:
                      - Aprova pleno
                      - Aprova
                      - Reprova
                  acao:
                    type: string
                    description: Acao operacional recomendada
                    enum:
                      - Prazo e TM liberados
                      - Monitorar
                      - Reprova
                      - Reprovado por regra dura
                  motivo_reprovacao:
                    type: string
                    description: Motivo da reprovacao (quando aplicavel)
                    example: "Tempo de vinculo inferior a 12 meses"
                  details:
                    type: object
                    properties:
                      pontos_vinculo:
                        type: integer
                      pontos_cnpj:
                        type: integer
                      tempo_vinculo_meses:
                        type: integer
                      tempo_empresa_meses:
                        type: integer
                      cnpj_defaulter:
                        type: object
                      cnae_defaulter:
                        type: object
                      cbo_defaulter:
                        type: object
        "400":
          description: Erro de validacao
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
                enum:
                  - Requisicao deve ser em formato JSON
                  - Campo 'tempo_vinculo_meses' e obrigatorio
                  - Campo 'tempo_empresa_meses' e obrigatorio
                  - Campo 'cnpj_data' e obrigatorio
                  - Campo 'cnae_data' e obrigatorio
                  - Campo 'cbo_data' e obrigatorio
        "500":
          description: Erro interno ao calcular score
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
                example: "Erro ao calcular score de credito: <detalhes>"

  /balanceInquiry:
    post:
      tags:
        - Vinculos
      summary: Envia consulta de saldo/vinculos
      description: |
        Envia uma consulta de dados trabalhistas para a API da QI Tech.
      security:
        - InternalToken: []
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: body
          required: true
          schema:
            type: object
            required:
              - cpf
              - registration_number
              - employer_document_number
            properties:
              cpf:
                type: string
                description: CPF do trabalhador
                example: "12345678900"
              registration_number:
                type: string
                description: Numero de matricula do trabalhador
                example: "123456"
              employer_document_number:
                type: string
                description: CNPJ do empregador
                example: "12345678000199"
              cnpj:
                type: string
                description: CNPJ para consulta (usado internamente)
                example: "12345678000199"
      responses:
        "200":
          description: Consulta realizada com sucesso
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: true
              data:
                type: object
                description: Dados retornados da consulta
        "400":
          description: Erro de validacao
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
                enum:
                  - Requisicao deve ser em formato JSON
                  - Campo 'cpf' e obrigatorio
                  - Campo 'registration_number' e obrigatorio
                  - Campo 'employer_document_number' e obrigatorio

  /createContract:
    post:
      tags:
        - Contrato
      summary: Gera um novo contrato de credito (CCB)
      description: |
        Endpoint para emissao de operacao de credito consignado.
        Gera uma CCB (Cedula de Credito Bancario) atraves da API da QI Tech.

        O contrato e criado com as informacoes do cliente, dados financeiros
        e conta bancaria para desembolso.

        Apos sucesso, os dados do contrato sao salvos na collection
        'contract_qitech' do Firestore.

        Tipos de desembolso:
        - account_pix: Transferencia para conta bancaria
        - key_pix: Transferencia via chave PIX

        Tipos de operacao:
        - installment: Baseado no valor da parcela
        - disbursed: Baseado no valor a ser desembolsado
      security:
        - InternalToken: []
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: body
          required: true
          schema:
            type: object
            required:
              - cliente_data
              - financial_info
              - disbursement_bank_accounts
            properties:
              cliente_data:
                type: object
                description: Informacoes pessoais do cliente
                properties:
                  name:
                    type: string
                    description: Nome completo
                    example: "Joao da Silva"
                  cpf:
                    type: string
                    description: CPF (apenas numeros)
                    example: "12345678900"
                  phone:
                    type: string
                    description: Telefone completo (DDI+DDD+numero)
                    example: "5527999999999"
                  email:
                    type: string
                    description: Email
                    example: "joao@email.com"
                  gender:
                    type: string
                    description: Genero
                    enum:
                      - male
                      - female
                  political_exposition:
                    type: string
                    description: Exposicao politica
                    enum:
                      - not_exposed
                      - exposed
                  city:
                    type: string
                    description: Cidade
                    example: "Vitoria"
                  state:
                    type: string
                    description: UF (2 caracteres)
                    example: "ES"
                  number_home:
                    type: string
                    description: Numero do endereco
                    example: "123"
                  street:
                    type: string
                    description: Nome da rua
                    example: "Rua das Flores"
                  complement:
                    type: string
                    description: Complemento do endereco
                    example: "Apto 101"
                  postal_code:
                    type: string
                    description: CEP
                    example: "29000000"
                  neighborhood:
                    type: string
                    description: Bairro
                    example: "Centro"
                  birth_date:
                    type: string
                    format: date
                    description: Data de nascimento (YYYY-MM-DD)
                    example: "1990-01-15"
                  mother_name:
                    type: string
                    description: Nome da mae
                    example: "Maria da Silva"
                  nationality:
                    type: string
                    description: Nacionalidade (opcional)
                    example: "Brasileira"
                  marital_status:
                    type: string
                    description: Estado civil
                    enum:
                      - single
                      - married
                      - divorced
                      - widowed
                      - legally_separated
                  document_type:
                    type: string
                    description: Tipo de documento de identificacao
                    enum:
                      - rg
                      - cnh
                      - passport
                      - rne
                  document_date:
                    type: string
                    format: date
                    description: Data de emissao do documento
                    example: "2015-05-20"
                  document_number:
                    type: string
                    description: Numero do documento
                    example: "MG12345678"
                  name_employer:
                    type: string
                    description: Nome do empregador
                    example: "Empresa LTDA"
                  salary:
                    type: number
                    description: Salario do cliente
                    example: 5000.00
                  margin:
                    type: number
                    description: Margem consignavel
                    example: 1500.00
                  admission_date:
                    type: string
                    format: date
                    description: Data de admissao
                    example: "2020-01-10"
              financial_info:
                type: object
                description: Informacoes da operacao de credito
                properties:
                  first_due_date:
                    type: string
                    format: date
                    description: Data do primeiro vencimento
                    example: "2024-02-10"
                  disbursement_date:
                    type: string
                    format: date
                    description: Data de desembolso
                    example: "2024-01-15"
                  monthly_interest_rate:
                    type: number
                    description: Taxa de juros mensal (decimal)
                    example: 0.0199
                  value:
                    type: number
                    description: Valor do contrato ou da parcela (depende de type_operation)
                    example: 5000.00
                  number_of_installments:
                    type: integer
                    description: Numero de parcelas
                    example: 24
                  purchaser_document_number:
                    type: string
                    description: CNPJ do fundo financiador
                    example: "53285246000113"
                  type_operation:
                    type: string
                    description: Tipo de operacao
                    enum:
                      - installment
                      - disbursed
                  employer_document_number:
                    type: string
                    description: CNPJ do empregador
                    example: "12345678000199"
                  registration_number:
                    type: string
                    description: Matricula do funcionario
                    example: "123456"
                  collateral_type:
                    type: string
                    description: Tipo de garantia
                    example: "employee_salary"
                  hasInsurance:
                    type: boolean
                    description: Indica se o contrato possui seguro
                    default: false
              disbursement_bank_accounts:
                type: object
                description: Informacoes da conta bancaria para desembolso
                properties:
                  pix_type:
                    type: string
                    description: Tipo de transferencia
                    enum:
                      - account_pix
                      - key_pix
                  name:
                    type: string
                    description: Nome do titular da conta
                    example: "Joao da Silva"
                  pix_key:
                    type: string
                    description: Chave PIX (obrigatorio se pix_type = key_pix)
                    example: "12345678900"
                  bank_code:
                    type: string
                    description: Codigo do banco (obrigatorio se pix_type = account_pix)
                    example: "341"
                  account_digit:
                    type: string
                    description: Digito da conta (obrigatorio se pix_type = account_pix)
                    example: "5"
                  account_number:
                    type: string
                    description: Numero da conta (obrigatorio se pix_type = account_pix)
                    example: "12345"
                  branch_number:
                    type: string
                    description: Numero da agencia (obrigatorio se pix_type = account_pix)
                    example: "1234"
      responses:
        "200":
          description: Contrato criado com sucesso
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: true
              data:
                type: object
                description: Dados do contrato gerado
        "400":
          description: Erro de validacao
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
        "500":
          description: Erro ao criar contrato
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
              details:
                type: object

  /getContractStatus:
    get:
      tags:
        - Contrato
      summary: Consulta o status de um contrato
      description: |
        Busca o status atual de um contrato pelo CPF do cliente.
      security:
        - InternalToken: []
      produces:
        - application/json
      parameters:
        - in: query
          name: cpf
          type: string
          required: true
          description: CPF do cliente
      responses:
        "200":
          description: Status do contrato
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: true
              data:
                type: object
                description: Dados do status do contrato
        "400":
          description: CPF nao informado
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
                example: "CPF e um parametro obrigatorio"
        "404":
          description: Contrato nao encontrado
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
                example: "Nenhum contrato encontrado para o CPF informado"

  /signContract:
    post:
      tags:
        - Contrato
      summary: Envia assinatura do contrato
      description: |
        Envia a assinatura eletronica do cliente para o contrato.
      security:
        - InternalToken: []
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: body
          required: true
          schema:
            type: object
            required:
              - cpf
              - contract_key
              - ip
            properties:
              cpf:
                type: string
                description: CPF do cliente
                example: "12345678900"
              contract_key:
                type: string
                description: Chave do contrato
                example: "abc123"
              ip:
                type: string
                description: IP do cliente
                example: "193.186.4.237"
      responses:
        "200":
          description: Contrato assinado com sucesso
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: true
              data:
                type: object
        "400":
          description: Erro de validacao
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
        "500":
          description: Erro ao assinar contrato
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              msg:
                type: string
              details:
                type: object
